<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./style.css"/>
    <!-- Bootstrap - Latest compiled and minified CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
</html>


</head>
<body>
    <a href="./index.html">Home</a>


    <h1>Calculator</h1>
    <form id="calcForm" onsubmit="return calc()">
        
        <input type="text" id="calcScreen" pattern="[0-9\%\^\*\(\)\/\\\*\-\+\.]*" value="10-(124+53-(1+5))"/>
        <table>
            <tbody>
                
                <tr>
                    <td><input type="button" value="7" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="8" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="9" onclick="addNumber(this.value)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="4" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="5" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="6" onclick="addNumber(this.value)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="1" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="2" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="3" onclick="addNumber(this.value)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="0" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="." onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="←" onclick="back()"></td>
                    
                </td>
                <tr>
                    <td><input type="button" value="/" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="*" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="-" onclick="addNumber(this.value)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="+" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="^" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value="%" onclick="addNumber(this.value)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="(" onclick="addNumber(this.value)"></td>
                    <td><input type="button" value=")" onclick="addNumber(this.value)"></td>
                    <td><input type="submit" value="↵">
                </tr>
            </tbody>
        </table>


    </form>

    <h2>History</h2>
    <div id="history"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        var calcScreen = document.getElementById("calcScreen");
        function addNumber(number){
            console.log("Adding: " + number + "to input");
            calcScreen.value = document.getElementById("calcScreen").value.concat(number);
        }
        
        var operators;
        var tokens;

        function calc(){
            var calcScreenValue = calcScreen.value;

            calcScreenValue = calcScreenValue.replace(' ', '');

            operators = calcScreenValue.match(/[\%\^\*\(\)\/\\\*\-\+]/g);
            tokens = calcScreenValue.split(/[\%\^\*\(\)\/\\\*\-\+]/g);

            var returnValue = calcRecursive(0, 0)

            calcScreen.value = returnValue;

            //History
            var newHistoryEntry = document.createElement("p");

            newHistoryEntry.appendChild(
                document.createTextNode(calcScreenValue + " = " + returnValue));
            
            document.getElementById("history").appendChild(newHistoryEntry);
            
            return false;
        }
 



        /*
        * Recessively process brackets down
        */
        function calcRecursive(start, level){
            console.log("Start - " + operators + " ||" + tokens + " level: " + level);

            for(var i = start; i < operators.length; i++){
                if(operators[i] == "("){
                    //Recursively Finds 
                    var result = calcRecursive(i+1, ++level);
                    i--;
                }
                else if(operators[i] == ")"){
                    console.log("End process - " + operators + " ||" + tokens + " level: " + level);
                    
                    
                    tokens.splice(start-1, 3, exponent(start, i));
                    operators.splice(start-1, 2);

                    return;
                }

            }
            
            console.log("End process - " + operators + " ||" + tokens + " level: " + level);

            return exponent(start, operators.length);
        }

        function exponent(start, end){
            for(var i = start; i < end; i++){
                if(operators[i] == '^'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Math.pow(Number(tokens[i]), Number(tokens[i+1])));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--;
                    end--;
                }
            }
            return mult_div(start, end)
        }

        function mult_div(start, end){
            for(var i = start; i < end; i++){
                if(operators[i] == '*'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Number(tokens[i]) * Number(tokens[i+1]));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--;
                    end--;
                }
                else if(operators[i] == '/' || operators[i] == '\\'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Number(tokens[i]) / Number(tokens[i+1]));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--
                    end--;
                }
                else if(operators[i] == '%'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Number(tokens[i]) % Number(tokens[i+1]));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--
                    end--;
                }
            }
            return add_sub(start, end);
        }

        function add_sub(start, end){
            for(var i = start; i < end; i++){
                if(operators[i] == '+'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Number(tokens[i]) + Number(tokens[i+1]));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--;
                    end--;
                }
                else if(operators[i] == '-'){
                    operators.splice(i, 1);
                    tokens.splice(i, 2, Number(tokens[i]) - Number(tokens[i+1]));

                    //With the removal from the array, this re-aligns the cursor and the end point 
                    i--
                    end--;
                }
            }
            return tokens[start];
        }

        function back(){
            
            if(calcScreen.value.length > 0){
                calcScreen.value = calcScreen.value.substring(0, calcScreen.value.length-1);
            }
        }
    </script>
</body>
</html>
